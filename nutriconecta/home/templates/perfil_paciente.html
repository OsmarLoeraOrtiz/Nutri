{% extends 'base.html' %}
{% load static %}


{% block titulo %}
    NutriConecta | Mi Perfil
{% endblock %}

{% block btns %}
<li><a href="{% url 'perfil' %}#perfil">Detalles de la Cuenta</a></li>
<li><a href="{% url 'perfil' %}#contact">Contactos</a></li>
<li><a href="{% url 'perfil' %}#agenda">Agenda</a></li>
{% endblock %}

{% block links %}
  <link href="{% static 'css/style.css' %}" rel="stylesheet">
  <link href="{% static 'lightbox/css/lightbox.css' %}" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="{% static 'css/backend-plugin.min.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static 'css/backend.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static 'css/all.min.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static 'css/line-awesome.min.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static 'css/dripicons.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static 'css/remixicon.css' %}">
{% endblock links %}

{% block contenido %}
<div class="modal fade" id="eliminarModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true"> 
  <div class="modal-dialog" role="document"> 
    <div class="modal-content"> 
      <div class="modal-header"> 
      <h5 class="modal-title" id="modalTitulo">Eliminar Solicitud de Cita</h5> 
      </button> 
      </div> 
      <div class="modal-body"> 
        <h6>¿Estas seguro de eliminar esta solicitud de cita?</h6>
      </div> 
      <div class="modal-footer"> 
      <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button> 
      <button type="button" class="btn btn-primary" id="eliminarCita">Eliminar</button> 
      </div> 
    </div> 
  </div> 
</div>
<div class="modal fade" id="cancelarModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true"> 
  <div class="modal-dialog" role="document"> 
    <div class="modal-content"> 
      <div class="modal-header"> 
      <h5 class="modal-title" id="modalTitulo">Cancelar Cita</h5> 
      </button> 
      </div> 
      <div class="modal-body"> 
        <h6>¿Estas seguro de cancelar esta cita?</h6>
      </div> 
      <div class="modal-footer"> 
      <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button> 
      <button type="button" class="btn btn-primary" id="cancelarCita">Cancelar</button> 
      </div> 
    </div> 
  </div> 
</div>
<section class="section profile">
  <div class="row">
    <div class="col-xl-4">

      <div class="card  mt-5 seccion_foto_fija">
        <div class="card-body pt-4 d-flex flex-column align-items-center">
          <img id="foto" src="" alt="Profile" class="fotoPerfil">
          <br>
          <h2 id="user"></h2>
          <h3 id="especialidad2"></h3>
          <h6 class="titulo_perfil">Sobre mí</h6>
              <p class="small fst-italic" id="descripcion"></p>
          <div class="social-links mt-2">
            <a href="#" id="twitter"><i class="bi bi-twitter"></i></a>
            <a href="#" id="facebook"><i class="bi bi-facebook"></i></a>
            <a href="#" id="instagram"><i class="bi bi-instagram"></i></a>
            <a href="#" id="linkedin"><i class="bi bi-linkedin"></i></a>
          </div>
        </div>
      </div>

    </div>
    {% if messages %}
    <ul class="messages">
      {% for message in messages %}
        <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}
    <div class="col-xl-8">

      <div class="card mt-5">
        <div class="card-body pt-3">
          <!-- Bordered Tabs -->
          <ul class="nav nav-tabs nav-tabs-bordered">

            <li class="nav-item">
              <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#profile-overview">Descripción</button>
            </li>

            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#profile-edit">Editar Perfil</button>
            </li>

            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#profile-settings">Ajustes</button>
            </li>

            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#profile-change-password">Cambiar contraseña</button>
            </li>

          </ul>
          <div class="tab-content pt-2">

            <div class="tab-pane fade show active profile-overview" id="profile-overview">
              
              <h4 class="titulo_perfil">Datos de la Cuenta</h4>
              <br>

              <div class="row">
                <div class="col-lg-3 col-md-4 label ">Nombre de usuario</div>
                <p class="col-lg-9 col-md-8" id="user2"></p>
              </div>

              <div class="row">
                <div class="col-lg-3 col-md-4 label ">Nombre completo</div>
                <p class="col-lg-9 col-md-8" id="nombre"></p>
              </div>

              <div class="row">
                <div class="col-lg-3 col-md-4 label ">Edad</div>
                <p class="col-lg-9 col-md-8" id="edad"></p>
              </div>

              <div class="row">
                <div class="col-lg-3 col-md-4 label ">Ubicación</div>
                <p class="col-lg-9 col-md-8" id="ubicacion"></p>
              </div>

              <div class="row">
                <div class="col-lg-3 col-md-4 label">Número de teléfono</div>
                <p class="col-lg-9 col-md-8" id="numero" ></p>
              </div>

              <div class="row">
                <div class="col-lg-3 col-md-4 label">Correo electrónico</div>
                <p class="col-lg-9 col-md-8" id="correo"></p>
              </div>

              <div>
                <h5 class="titulo_perfil" id="contact">Contactos</h5>
                <br>

                <div class="row">
                  <p class="text-center" id="contactos"></p>
                </div>
                
              </div>
            </div>

            <div class="tab-pane fade profile-edit pt-3" id="profile-edit">

              <!-- Profile Edit Form -->
              <h5 class="titulo_perfil">Datos Personales</h5>
              <form method="post" enctype="multipart/form-data" action="{% url 'actualizar_paciente' %}">
                {% csrf_token %}
                <p>
                  <label for="firstName" class="col-md-4 col-lg-3 col-form-label">Nombre/s:</label>
                  <input name="firstName" type="text" class="form-control" id="firstName">
                </p>

                <p>
                  <label for="lastName" class="col-md-4 col-lg-3 col-form-label">Apellidos:</label>
                  <input name="lastName" type="text" class="form-control" id="lastName">
                </p>

                <p>
                  <label for="correo2" class="col-md-4 col-lg-3 col-form-label">Correo electrónico:</label>
                  <input name="correo2" type="text" class="form-control" id="correo2">
                </p>
                  {{ form.as_p }}
                <div class="text-center">
                  <button type="submit" class="btn btn-primary">Guardar cambios</button>
                </div>
              </form>

            </div>
          </div>

            <div class="tab-pane fade pt-3" id="profile-settings">
              <!-- Settings Form -->
              {% if not correo_verificado %}
              <div class="">
                <div class="text-center">
                  <label class="col-md-4 col-lg-3 col-form-label">Debes confirmar tu correo para acceder a esta función.</label>
                  <div class="text-center">
                    <a href="{% url 'enviar_correo_confirmacion' %}" style="display: inline-block; padding: 10px 20px; background-color: #4CAF50; color: #ffffff; text-decoration: none; border-radius: 5px;">Confirmar Correo</a>
                  </div>
                </div>
              </div>
              {% else %}
              <form method="post" enctype="multipart/form-data" action="{% url 'ajuste_notificaciones' %}">
                {% csrf_token %}
                
                <div class="row mb-3">
                    <label class="col-md-4 col-lg-3 col-form-label">Notificaciones de Correo electrónico</label>
                    <div class="col-md-8 col-lg-9">
                        <div class="form-check">
                          {% if ajuste_notificaciones.cambios  %}
                            <input class="form-check-input" type="checkbox" id="cambios" name="cambios" checked>
                          {% else %}
                            <input class="form-check-input" type="checkbox" id="cambios" name="cambios">
                          {% endif %}
                            <label class="form-check-label" for="cambios">
                                Cambios realizados en su cuenta
                            </label>
                        </div>
                        <div class="form-check">
                        {% if ajuste_notificaciones.servicios  %}
                          <input class="form-check-input" type="checkbox" id="servicios" name="servicios" checked>
                        {% else %}
                          <input class="form-check-input" type="checkbox" id="servicios" name="servicios">
                        {% endif %}
                            <label class="form-check-label" for="servicios">
                                Información sobre nuevos productos y servicios.
                            </label>
                        </div>
                        <div class="form-check">
                          {% if ajuste_notificaciones.promociones  %}
                            <input class="form-check-input" type="checkbox" id="promociones" name="promociones" checked>
                          {% else %}
                            <input class="form-check-input" type="checkbox" id="promociones" name="promociones">
                          {% endif %}
                            <label class="form-check-label" for="promociones">
                                Ofertas promocionales y de marketing
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="securityNotify" name="securityNotify" checked disabled>
                            <label class="form-check-label" for="securityNotify">
                                Alertas de seguridad
                            </label>
                        </div>
                    </div>
                </div>
                <div class="text-center">
                    <button type="submit" class="btn btn-primary">Guardar cambios</button>
                </div>
            </form>
              {% endif %}

            </div>

            <div class="tab-pane fade pt-3" id="profile-change-password">
              <!-- Change Password Form -->
              <form method="post" action="{% url 'actualizar_password' %}">
                {% csrf_token %}

                <div class="row mb-3">
                  <label for="password_actual" class="col-md-4 col-lg-3 col-form-label">Contraseña actual</label>
                  <div class="col-md-8 col-lg-9">
                    <input name="password_actual" type="password" class="form-control" id="password_actual">
                  </div>
                </div>

                <div class="row mb-3">
                  <label for="nueva_password" class="col-md-4 col-lg-3 col-form-label">Nueva Contraseña</label>
                  <div class="col-md-8 col-lg-9">
                    <input name="nueva_password" type="password" class="form-control" id="nueva_password">
                  </div>
                </div>

                <div class="row mb-3">
                  <label for="confirmar_password" class="col-md-4 col-lg-3 col-form-label">Repita la Nueva Contraseña</label>
                  <div class="col-md-8 col-lg-9">
                    <input name="confirmar_password" type="password" class="form-control" id="confirmar_password">
                  </div>
                </div>

                <div class="text-center">
                  <button type="submit" class="btn btn-primary">Cambiar Contraseña</button>
                </div>
              </form><!-- End Change Password Form -->

            </div>

          </div><!-- End Bordered Tabs -->

        </div>
      </div>

    </div>
  </div>
</section>

<section id="agenda" class="service-details">
  <div class="col-lg-12" >                
      <div class="card card-block card-stretch">
          <div class="card-body custom-notes-space">
              <h3 class="">Agenda de Citas</h3>
              <div class="iq-tab-content">
                  <div class="d-flex flex-wrap align-items-top justify-content-between">
                      <ul class="d-flex nav nav-pills text-center note-tab mb-3" id="note-pills-tab" role="tablist">                                
                          <li class="nav-item">
                              <a class="nav-link home active show" data-toggle="pill" data-init="note" href="#note1" role="tab" aria-selected="false">Proximas Citas</a>
                          </li>
                          <li class="nav-item">
                              <a class="nav-link home" data-toggle="pill" data-init="shared-note" href="#note2" role="tab" aria-selected="true">Solicitudes de Citas</a>
                          </li>
                      </ul> 
                                
                  </div>             
                  <div class="note-content tab-content">                                
                      <div id="note1" class="tab-pane fade active show">
                          <div class="calendar-container" id="calendar-container">
                              <div class="calendar active" id="calendar">{% csrf_token %}</div>
                              <br>
                          </div>
                          <br>

                      </div>
                      <div id="note2" class="tab-pane fade active ">
                          <div class="calendar-container" id="calendar-container2">
                              <div class="calendar active" id="calendar1">{% csrf_token %}</div>
                          </div>
                          <br>

                      </div> 
                  </div> 
              </div>
          </div>
      </div>
  </div>
</section>
{% endblock %}
 
{% block scripts %}
<script src="{% static 'ckeditor/ckeditor.js' %}"></script>
  <script src="{% static 'ckeditor/lang/es.js' %}"></script>
  <link href="{% static 'lightbox/js/lightbox.js' %}" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="{% static 'js/datosPerfil.js' %}"></script>
  
  {% if request.GET.success %}
    <script>
        alert("Se han actualizado tus datos correctamente.");
    </script>
  {% elif request.GET.error %}
    <script>
        alert("Error al actualizar tus datos.");
    </script>
  {% endif %}
  
  <script>
    var username = "{{ usuario.user}}"; // Obtener el nombre de usuario del nutriólogo
    var paciente_name = "{{ usuario.paciente}}"; // Obtener el nombre de usuario del nutriólogo
    var obtenerCitasPublico = `/obtener_citas_publico/${username}/`;
    var obtenerSolicitudCitasPorNutriologo = `/obtener_solicitud_citas_enviadas/${username}/`;
    var agendarCitasPublico = `/agendar_cita/${username}/`;
  </script>

  <script src="{% static 'js/index.global.min.js' %}" ></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            navLinks: true,
            selectable: true,
            eventClick: function(arg) {
              mostrarModalCancelar().then(function(result) {
                  if (result) {
                      // Aquí dentro puedes realizar la lógica después de hacer clic en el botón "Guardar"
                      var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                      $.ajax({
                          url: '/nutriologo/eliminar_cita/',
                          type: 'POST',
                          headers: {
                              'X-CSRFToken': csrfToken  
                          },
                          data: {
                              id: arg.event.id
                          },
                          success: function(response) {
                              alert(response.mensaje);
                              arg.event.remove();
                              $('#datos-paciente').attr('id', 'hidden');
                              obtenerCitas();
                          },
                          error: function(xhr, status, error) {
                              console.error('Error al eliminar el evento:', error);
                          }
                      });
                  }
              });
            },
            editable: false,
            dayMaxEvents: true,
            events: '/obtener_citas_paciente/',
        });

        calendar.render();
        inicializarSegundoCalendario();

        function inicializarSegundoCalendario() {
            var calendar1El = document.getElementById('calendar1');
            var calendar1 = new FullCalendar.Calendar(calendar1El, {
        
          headerToolbar: {
              left: 'prev,next today',
              center: 'title',
              right: 'dayGridMonth,timeGridWeek,timeGridDay'
          },
          navLinks: true,
          selectable: true,
          eventClick: function(arg) {
            mostrarModalEliminar().then(function(result) {
              if (result) {
                  // Aquí dentro puedes realizar la lógica después de hacer clic en el botón "Guardar"
                  var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                  $.ajax({
                      url: '/eliminar_solicitud_cita/',
                      type: 'POST',
                      headers: {
                          'X-CSRFToken': csrfToken  
                      },
                      data: {
                          id: arg.event.id
                      },
                      success: function(response) {
                          alert(response.mensaje);
                          arg.event.remove();
                          $('#datos-paciente').attr('id', 'hidden');
                          obtenerCitas();
                      },
                      error: function(xhr, status, error) {
                          console.error('Error al eliminar el evento:', error);
                      }
                  });
              }
          });
          },
          editable: true,
          dayMaxEvents: true,
          events: '/obtener_solicitud_citas_enviadas_paciente/' 
      });

      calendar1.render();

        }
    });
</script>

<script>
  function mostrarModalCancelar() {
      return new Promise(function(resolve, reject) {
          var modal = $('#cancelarModal');
          modal.modal('show');
  
          // Agrega un evento al botón de guardar dentro del modal
          $('#cancelarModal .btn-primary').on('click', function() {
              modal.modal('hide');
              resolve(true);
          });
  
          $('#cancelarModal .btn-secondary').on('click', function() {
              modal.modal('hide');
              resolve(false);
          });
      });
  }
  </script>

  <script>
    function mostrarModalEliminar() {
        return new Promise(function(resolve, reject) {
            var modal = $('#eliminarModal');
            modal.modal('show');
    
            // Agrega un evento al botón de guardar dentro del modal
            $('#eliminarModal .btn-primary').on('click', function() {
                modal.modal('hide');
                resolve(true);
            });
    
            $('#eliminarModal .btn-secondary').on('click', function() {
                modal.modal('hide');
                resolve(false);
            });
        });
    }
    </script>

<script>
  function mostrarModalCrear() {
    return new Promise(function(resolve, reject) {
        var modal = $('#listaModal');
        modal.modal('show');

        // Agrega un evento al botón de guardar dentro del modal
        $('#listaModal .btn-primary').on('click', function() {
            // Obtiene los valores del título y del paciente
            var title = $('#tituloCita').val();
            var motivo = $('#motivoCita').val();
            var paciente = paciente_name;

            // Verifica si ambos campos están llenos
            if (title && paciente && motivo) {
                // Resuelve la promesa con los valores
                resolve({ title: title, paciente: paciente, motivo: motivo });

                // Cierra el modal
                modal.modal('hide');
            } else {
                // Rechaza la promesa si no se llenaron ambos campos
                alert("Por favor, llene todos los campos.");
            }
        });
        $('#listaModal .btn-secondary').on('click', function() {
          modal.modal('hide');
        });

    });
}
</script>

<script>
  function obtenerCitasPublicas(){
    $.ajax({
        url: obtenerCitasPublico,  
        type: 'GET',
        success: function(response) {
            // Maneja la respuesta y construye el contenido HTML para mostrar todos los pacientes
            var contenidoHTML = '<ul>';
            $.each(response, function(index, cita) {
              contenidoHTML += `<li><a href="#foto" onclick="changeClass(this)" class="btn" data-id="${cita.id_paciente }"><i class="bi bi-arrow-right-circle"></i><span>${cita.nombre_paciente} | Prox. cita: ${cita.fecha_inicio} ${cita.hora_inicio}</span></a></li>`;

            });
            contenidoHTML += '</ul>';

            // Actualiza el contenido del elemento "datos-paciente"
            $('#pacientes').html(contenidoHTML);
        },
        error: function(response) {
          console.log('LA cagaste:', response);
        }
    });
  }
  $(document).ready(function() {
    // Realiza una solicitud AJAX para obtener las citas de todos los pacientes

    try {
      obtenerCitasPublicas()
    } catch (error) {
      console.log('Error:', error);
    }
    
  });
  </script>
{% endblock %}

